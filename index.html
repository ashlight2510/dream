<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      property="og:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&amp;text=Dream"
    />
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1204894220949193"
      crossorigin="anonymous"
    ></script>
    <title>ê¿ˆì¼ê¸°</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <style>
      :root {
        --bg: #0b0f14;
        --card: #121926;
        --muted: #8aa0b8;
        --text: #eaf2ff;
        --accent: #6aa9ff;
        --danger: #ff6a6a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR",
          sans-serif;
        background: radial-gradient(
          1000px 600px at 20% 0%,
          #142038 0%,
          var(--bg) 60%
        );
        color: var(--text);
      }
      header {
        padding: 24px 16px 8px;
        max-width: 980px;
        margin: 16px auto;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 24px;
        letter-spacing: -0.2px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.4;
      }
      main {
        max-width: 980px;
        margin: 16px auto;
        padding: 16px;
        display: grid;
        gap: 16px;
        grid-template-columns: 1.2fr 1fr;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: color-mix(in srgb, var(--card) 92%, #000 8%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .row {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr 1fr;
      }
      @media (max-width: 520px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input,
      textarea,
      select {
        width: 100%;
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
        line-height: 1.5;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border-color: color-mix(in srgb, var(--accent) 70%, #fff 30%);
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: 0;
        border-radius: 12px;
        padding: 10px 12px;
        cursor: pointer;
        color: var(--text);
        background: rgba(255, 255, 255, 0.1);
      }
      button.primary {
        background: color-mix(in srgb, var(--accent) 70%, #000 30%);
      }
      button.danger {
        background: color-mix(in srgb, var(--danger) 65%, #000 35%);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      .toolbar > * {
        flex: 1;
        min-width: 160px;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .item {
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.05);
      }
      .meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--muted);
        background: rgba(0, 0, 0, 0.2);
      }
      .title {
        font-weight: 700;
        margin: 8px 0 6px;
      }
      .content {
        color: rgba(234, 242, 255, 0.9);
        white-space: pre-wrap;
        line-height: 1.6;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .split {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .split button {
        flex: 1;
      }
      .empty {
        color: var(--muted);
        text-align: center;
        padding: 24px 8px;
      }
      .lang-switch {
        position: fixed;
        top: 16px;
        right: 16px;
        display: inline-flex;
        gap: 0;
        padding: 3px;
        border-radius: 999px;
        background: rgba(18, 25, 38, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 100;
        border: 1px solid rgba(106, 169, 255, 0.2);
      }
      .lang-switch button {
        border: none;
        background: transparent;
        color: rgba(234, 242, 255, 0.6);
        font-size: 12px;
        font-weight: 700;
        padding: 7px 14px;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 44px;
        text-align: center;
        letter-spacing: 0.02em;
      }
      .lang-switch button.active {
        background: rgba(106, 169, 255, 0.3);
        color: #eaf2ff;
        box-shadow: 0 2px 8px rgba(106, 169, 255, 0.4);
      }
      .lang-switch button:not(.active):hover {
        background: rgba(106, 169, 255, 0.1);
        color: rgba(234, 242, 255, 0.9);
      }
      .footer {
        max-width: 980px;
        margin: 16px auto;
        padding: 0 16px 24px;
        color: var(--muted);
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }
      .external-link {
        display: inline-block;
        font-size: 12px;
        padding: 8px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        text-decoration: none;
        transition: background 0.2s;
      }
      .external-link:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .footer-links {
        max-width: 980px;
        margin: 16px auto;
        padding: 16px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
    </style>
      <!-- responsive-base -->
    <style>
      /* responsive-base */
      *, *::before, *::after {
        box-sizing: border-box;
      }
      html {
        -webkit-text-size-adjust: 100%;
      }
      img,
      video,
      canvas,
      svg {
        max-width: 100%;
        height: auto;
      }
      table {
        width: 100%;
      }
      pre,
      code {
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  <style>
    .adsense-block {
      margin: 16px 0;
      display: flex;
      justify-content: center;
    }
    .adsbygoogle {
      display: block;
      margin: 16px auto;
        text-align: center;
}
  </style>
</head>

  <body>
    <div class="lang-switch" role="tablist" aria-label="Language switcher">
      <button type="button" data-lang="ko" class="active">KR</button>
      <button type="button" data-lang="en">EN</button>
    </div>
    <header>
      <h1 data-i18n="title">ê¿ˆì¼ê¸°</h1>
      <div class="sub" data-i18n-html="subtitle">
        ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ëŠ” ê°œì¸ ê¿ˆ ê¸°ë¡ì¥ (localStorage ì‚¬ìš©).<br />
        ë‚´ë³´ë‚´ê¸°(JSON)ë¡œ ë°±ì—…í•˜ê±°ë‚˜ ê°€ì ¸ì˜¤ê¸°(JSON)ë¡œ ë³µì›í•  ìˆ˜ ìˆì–´ìš”.
      </div>
    </header>

    <main>
      <!-- ì…ë ¥ -->
      <section class="card" aria-label="ê¿ˆì¼ê¸° ì‘ì„±">
        <h2 style="margin: 0 0 12px; font-size: 16px" data-i18n="recordTitle">ê¸°ë¡í•˜ê¸°</h2>

        <div class="row">
          <div>
            <label for="date" data-i18n="dateLabel">ë‚ ì§œ</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="lucid" data-i18n="lucidLabel">ìê°ëª½</label>
            <select id="lucid">
              <option value="no" data-i18n="lucidNo">ì•„ë‹ˆì˜¤</option>
              <option value="yes" data-i18n="lucidYes">ì˜ˆ</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 10px">
          <div>
            <label for="mood" data-i18n="moodLabel">ê¸°ë¶„</label>
            <select id="mood">
              <option value="ğŸ™‚ ì¢‹ìŒ">ğŸ™‚ ì¢‹ìŒ</option>
              <option value="ğŸ˜ ë³´í†µ">ğŸ˜ ë³´í†µ</option>
              <option value="ğŸ˜Ÿ ë¶ˆì•ˆ">ğŸ˜Ÿ ë¶ˆì•ˆ</option>
              <option value="ğŸ˜± ì•…ëª½">ğŸ˜± ì•…ëª½</option>
              <option value="ğŸ¤¯ í˜¼ë€">ğŸ¤¯ í˜¼ë€</option>
            </select>
          </div>
          <div>
            <label for="tags" data-i18n="tagsLabel">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
            <input id="tags" data-i18n-placeholder="tagsPlaceholder" placeholder="ì˜ˆ: í•™êµ, ë°”ë‹¤, ì¶”ê²©ì „" />
          </div>
        </div>

        <div style="margin-top: 10px">
          <label for="title" data-i18n="titleLabel">ì œëª©</label>
          <input
            id="title"
            data-i18n-placeholder="titlePlaceholder"
            placeholder="ì˜ˆ: ë°”ë‹¤ ìœ„ë¥¼ ê±·ëŠ” ê¿ˆ"
            maxlength="80"
          />
        </div>

        <div style="margin-top: 10px">
          <label for="content" data-i18n="contentLabel">ë‚´ìš©</label>
          <textarea
            id="content"
            data-i18n-placeholder="contentPlaceholder"
            placeholder="ê¿ˆ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."
          ></textarea>
        </div>

        <div class="actions">
          <button class="primary" id="saveBtn" data-i18n="saveBtn">ì €ì¥</button>
          <button id="resetBtn" type="button" data-i18n="resetBtn">ì…ë ¥ ì´ˆê¸°í™”</button>
          <button class="danger" id="deleteSelectedBtn" type="button" disabled data-i18n="deleteSelectedBtn">
            ì„ íƒ ì‚­ì œ
          </button>
        </div>

        <hr
          style="
            border: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            margin: 16px 0;
          "
        />

        <h3 style="margin: 0 0 10px; font-size: 14px" data-i18n="backupTitle">ë°±ì—…/ë³µì›</h3>
        <div class="split">
          <button id="exportBtn" type="button" data-i18n="exportBtn">ë‚´ë³´ë‚´ê¸° (JSON)</button>
          <button id="importBtn" type="button" data-i18n="importBtn">ê°€ì ¸ì˜¤ê¸° (JSON)</button>
        </div>
        <input id="importFile" type="file" accept="application/json" hidden />
        <p class="muted" style="margin: 10px 0 0" data-i18n-html="storageNote">
          ì €ì¥ ìœ„ì¹˜: <span class="mono">localStorage</span> (ì´ ë¸Œë¼ìš°ì €/ê¸°ê¸°
          ë‚´)
        </p>
      </section>

      <!-- ëª©ë¡ -->
      <section class="card" aria-label="ê¿ˆì¼ê¸° ëª©ë¡">
        <div class="toolbar">
          <div>
            <label for="search" data-i18n="searchLabel">ê²€ìƒ‰</label>
            <input id="search" data-i18n-placeholder="searchPlaceholder" placeholder="ì œëª©/ë‚´ìš©/íƒœê·¸ ê²€ìƒ‰" />
          </div>
          <div>
            <label for="filterMood" data-i18n="filterMoodLabel">ê¸°ë¶„ í•„í„°</label>
            <select id="filterMood">
              <option value="" data-i18n="filterMoodAll">ì „ì²´</option>
              <option value="ğŸ™‚ ì¢‹ìŒ">ğŸ™‚ ì¢‹ìŒ</option>
              <option value="ğŸ˜ ë³´í†µ">ğŸ˜ ë³´í†µ</option>
              <option value="ğŸ˜Ÿ ë¶ˆì•ˆ">ğŸ˜Ÿ ë¶ˆì•ˆ</option>
              <option value="ğŸ˜± ì•…ëª½">ğŸ˜± ì•…ëª½</option>
              <option value="ğŸ¤¯ í˜¼ë€">ğŸ¤¯ í˜¼ë€</option>
            </select>
          </div>
          <div>
            <label for="sort" data-i18n="sortLabel">ì •ë ¬</label>
            <select id="sort">
              <option value="new" data-i18n="sortNew">ìµœì‹ ìˆœ</option>
              <option value="old" data-i18n="sortOld">ì˜¤ë˜ëœìˆœ</option>
            </select>
          </div>
        </div>

        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display: none" data-i18n="emptyMessage">
          ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ì™¼ìª½ì—ì„œ ê¿ˆì„ ì €ì¥í•´ ë³´ì„¸ìš”.
        </div>
      </section>
    </main>

    <div class="footer-links">
      <a
        href="https://funnyfunny.cloud/"
        class="external-link"
        target="_blank"
        rel="noopener noreferrer"
      >
        ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸° â†—
      </a>
    </div>

    <script>
      // ----- Data layer (localStorage) -----
      const STORAGE_KEY = "dream_journal_v1";
      /** @typedef {{id:string, date:string, title:string, content:string, mood:string, lucid:boolean, tags:string[], createdAt:number}} Dream */

      function loadDreams() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(arr)) return [];
          return arr;
        } catch {
          return [];
        }
      }

      function saveDreams(dreams) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dreams));
      }

      function uid() {
        return (
          Math.random().toString(16).slice(2) + "-" + Date.now().toString(16)
        );
      }

      // ----- UI refs -----
      const $ = (id) => document.getElementById(id);

      const dateEl = $("date");
      const lucidEl = $("lucid");
      const moodEl = $("mood");
      const tagsEl = $("tags");
      const titleEl = $("title");
      const contentEl = $("content");

      const saveBtn = $("saveBtn");
      const resetBtn = $("resetBtn");
      const deleteSelectedBtn = $("deleteSelectedBtn");

      const searchEl = $("search");
      const filterMoodEl = $("filterMood");
      const sortEl = $("sort");

      const listEl = $("list");
      const emptyEl = $("empty");

      const exportBtn = $("exportBtn");
      const importBtn = $("importBtn");
      const importFileEl = $("importFile");

      // ----- State -----
      let dreams = loadDreams();
      let selectedIds = new Set();

      // default date = today (local)
      const today = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      dateEl.value = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(
        today.getDate()
      )}`;

      // ----- Helpers -----
      function parseTags(input) {
        return input
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean)
          .slice(0, 20);
      }

      function escapeHtml(str) {
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }

      function formatDate(iso) {
        if (!iso) return t("noDate");
        const [y, m, d] = iso.split("-");
        return `${y}.${m}.${d}`;
      }

      function matches(d, q, moodFilter) {
        const query = q.trim().toLowerCase();
        const hay = [
          d.title,
          d.content,
          d.tags.join(" "),
          d.mood,
          d.lucid ? t("lucidDream") : "",
        ]
          .join(" ")
          .toLowerCase();

        const okQuery = !query || hay.includes(query);
        const okMood = !moodFilter || d.mood === moodFilter;
        return okQuery && okMood;
      }

      function sortDreams(arr, mode) {
        const copy = [...arr];
        copy.sort((a, b) =>
          mode === "old" ? a.createdAt - b.createdAt : b.createdAt - a.createdAt
        );
        return copy;
      }

      function updateDeleteButton() {
        deleteSelectedBtn.disabled = selectedIds.size === 0;
        deleteSelectedBtn.textContent = selectedIds.size
          ? `${t("deleteSelectedBtn")} (${selectedIds.size})`
          : t("deleteSelectedBtn");
      }

      // ----- Render -----
      function render() {
        const q = searchEl.value || "";
        const moodFilter = filterMoodEl.value || "";
        const sorted = sortDreams(dreams, sortEl.value);

        const filtered = sorted.filter((d) => matches(d, q, moodFilter));

        listEl.innerHTML = "";
        if (filtered.length === 0) {
          emptyEl.style.display = "block";
          return;
        }
        emptyEl.style.display = "none";

        for (const d of filtered) {
          const isChecked = selectedIds.has(d.id);
          const tags = d.tags
            .map((t) => `<span class="badge">#${escapeHtml(t)}</span>`)
            .join(" ");

          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
          <div class="meta">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" data-id="${d.id}" ${
            isChecked ? "checked" : ""
          } />
              <span class="badge">${escapeHtml(formatDate(d.date))}</span>
              <span class="badge">${escapeHtml(d.mood)}</span>
              <span class="badge">${d.lucid ? t("lucidDream") : t("normalDream")}</span>
            </label>
          </div>
          <div class="title">${escapeHtml(d.title || t("noTitle"))}</div>
          <div class="content">${escapeHtml(d.content || "")}</div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            ${tags || `<span class="muted">${t("noTags")}</span>`}
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" data-edit="${d.id}">${t("editBtn")}</button>
            <button type="button" class="danger" data-remove="${
              d.id
            }">${t("deleteBtn")}</button>
          </div>
        `;

          listEl.appendChild(el);
        }

        updateDeleteButton();
      }

      // ----- Actions -----
      function resetForm() {
        lucidEl.value = "no";
        moodEl.value = "ğŸ™‚ ì¢‹ìŒ";
        tagsEl.value = "";
        titleEl.value = "";
        contentEl.value = "";
        titleEl.focus();
      }

      function upsertDream(editedId = null) {
        const date = dateEl.value;
        const title = titleEl.value.trim();
        const content = contentEl.value.trim();
        const mood = moodEl.value;
        const lucid = lucidEl.value === "yes";
        const tags = parseTags(tagsEl.value);

        if (!date) {
          alert(t("alertDateRequired"));
          return;
        }
        if (!title && !content) {
          alert(t("alertContentRequired"));
          return;
        }

        if (editedId) {
          const idx = dreams.findIndex((d) => d.id === editedId);
          if (idx === -1) return;
          dreams[idx] = {
            ...dreams[idx],
            date,
            title,
            content,
            mood,
            lucid,
            tags,
          };
        } else {
          /** @type {Dream} */
          const d = {
            id: uid(),
            date,
            title,
            content,
            mood,
            lucid,
            tags,
            createdAt: Date.now(),
          };
          dreams.push(d);
        }

        saveDreams(dreams);
        render();
        resetForm();
      }

      // ----- Event wiring -----
      saveBtn.addEventListener("click", () => upsertDream());

      resetBtn.addEventListener("click", () => resetForm());

      deleteSelectedBtn.addEventListener("click", () => {
        if (selectedIds.size === 0) return;
        if (!confirm(t("confirmDelete", { count: selectedIds.size }))) return;
        dreams = dreams.filter((d) => !selectedIds.has(d.id));
        selectedIds.clear();
        saveDreams(dreams);
        render();
      });

      listEl.addEventListener("click", (e) => {
        const t = e.target;

        // delete one
        if (t && t.dataset && t.dataset.remove) {
          const id = t.dataset.remove;
          const d = dreams.find((x) => x.id === id);
          if (!d) return;
          if (!confirm(t("confirmDeleteOne", { title: d.title || t("noTitle") })))
            return;
          dreams = dreams.filter((x) => x.id !== id);
          selectedIds.delete(id);
          saveDreams(dreams);
          render();
          return;
        }

        // edit
        if (t && t.dataset && t.dataset.edit) {
          const id = t.dataset.edit;
          const d = dreams.find((x) => x.id === id);
          if (!d) return;

          // load into form
          dateEl.value = d.date || dateEl.value;
          lucidEl.value = d.lucid ? "yes" : "no";
          moodEl.value = d.mood || "ğŸ™‚ ì¢‹ìŒ";
          tagsEl.value = (d.tags || []).join(", ");
          titleEl.value = d.title || "";
          contentEl.value = d.content || "";

          // transform save button into "update once"
          saveBtn.textContent = t("updateBtn");
          saveBtn.classList.add("primary");

          const handler = () => {
            upsertDream(id);
            saveBtn.textContent = t("saveBtn");
            saveBtn.removeEventListener("click", handler);
          };
          saveBtn.addEventListener("click", handler, { once: true });

          titleEl.focus();
          return;
        }
      });

      listEl.addEventListener("change", (e) => {
        const t = e.target;
        if (t && t.matches('input[type="checkbox"][data-id]')) {
          const id = t.dataset.id;
          if (t.checked) selectedIds.add(id);
          else selectedIds.delete(id);
          updateDeleteButton();
        }
      });

      [searchEl, filterMoodEl, sortEl].forEach((el) =>
        el.addEventListener("input", render)
      );

      // export/import
      exportBtn.addEventListener("click", () => {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          dreams,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dream-journal-backup-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener("click", () => importFileEl.click());

      importFileEl.addEventListener("change", async () => {
        const file = importFileEl.files?.[0];
        if (!file) return;

        try {
          const text = await file.text();
          const parsed = JSON.parse(text);

          const incoming = Array.isArray(parsed) ? parsed : parsed?.dreams;
          if (!Array.isArray(incoming))
            throw new Error(t("importFormatError"));

          // minimal validation
          const cleaned = incoming
            .filter((d) => d && typeof d === "object")
            .map((d) => ({
              id: typeof d.id === "string" ? d.id : uid(),
              date: typeof d.date === "string" ? d.date : "",
              title: typeof d.title === "string" ? d.title : "",
              content: typeof d.content === "string" ? d.content : "",
              mood: typeof d.mood === "string" ? d.mood : "ğŸ˜ ë³´í†µ",
              lucid: !!d.lucid,
              tags: Array.isArray(d.tags) ? d.tags.map(String) : [],
              createdAt:
                typeof d.createdAt === "number" ? d.createdAt : Date.now(),
            }));

          const merge = confirm(t("importMergeConfirm"));
          dreams = merge ? [...dreams, ...cleaned] : cleaned;

          // de-dup by id
          const map = new Map();
          for (const d of dreams) map.set(d.id, d);
          dreams = Array.from(map.values());

          saveDreams(dreams);
          selectedIds.clear();
          render();
          alert(t("importSuccess"));
        } catch (err) {
          alert(t("importFail", { error: err?.message || t("importFormatError") }));
        } finally {
          importFileEl.value = "";
        }
      });

      // first render
      render();

      // i18n
      const translations = {
        ko: {
          title: "ê¿ˆì¼ê¸°",
          subtitle: "ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ëŠ” ê°œì¸ ê¿ˆ ê¸°ë¡ì¥ (localStorage ì‚¬ìš©).<br />ë‚´ë³´ë‚´ê¸°(JSON)ë¡œ ë°±ì—…í•˜ê±°ë‚˜ ê°€ì ¸ì˜¤ê¸°(JSON)ë¡œ ë³µì›í•  ìˆ˜ ìˆì–´ìš”.",
          recordTitle: "ê¸°ë¡í•˜ê¸°",
          dateLabel: "ë‚ ì§œ",
          lucidLabel: "ìê°ëª½",
          lucidNo: "ì•„ë‹ˆì˜¤",
          lucidYes: "ì˜ˆ",
          moodLabel: "ê¸°ë¶„",
          tagsLabel: "íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)",
          tagsPlaceholder: "ì˜ˆ: í•™êµ, ë°”ë‹¤, ì¶”ê²©ì „",
          titleLabel: "ì œëª©",
          titlePlaceholder: "ì˜ˆ: ë°”ë‹¤ ìœ„ë¥¼ ê±·ëŠ” ê¿ˆ",
          contentLabel: "ë‚´ìš©",
          contentPlaceholder: "ê¿ˆ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.",
          saveBtn: "ì €ì¥",
          resetBtn: "ì…ë ¥ ì´ˆê¸°í™”",
          deleteSelectedBtn: "ì„ íƒ ì‚­ì œ",
          backupTitle: "ë°±ì—…/ë³µì›",
          exportBtn: "ë‚´ë³´ë‚´ê¸° (JSON)",
          importBtn: "ê°€ì ¸ì˜¤ê¸° (JSON)",
          storageNote: "ì €ì¥ ìœ„ì¹˜: <span class=\"mono\">localStorage</span> (ì´ ë¸Œë¼ìš°ì €/ê¸°ê¸° ë‚´)",
          searchLabel: "ê²€ìƒ‰",
          searchPlaceholder: "ì œëª©/ë‚´ìš©/íƒœê·¸ ê²€ìƒ‰",
          filterMoodLabel: "ê¸°ë¶„ í•„í„°",
          filterMoodAll: "ì „ì²´",
          sortLabel: "ì •ë ¬",
          sortNew: "ìµœì‹ ìˆœ",
          sortOld: "ì˜¤ë˜ëœìˆœ",
          emptyMessage: "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ì™¼ìª½ì—ì„œ ê¿ˆì„ ì €ì¥í•´ ë³´ì„¸ìš”.",
          otherServices: "ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸° â†—",
          alertDateRequired: "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",
          alertContentRequired: "ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
          confirmDelete: "{count}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
          confirmDeleteOne: '"{title}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          lucidDream: "ìê°ëª½",
          normalDream: "ì¼ë°˜",
          noTitle: "(ì œëª© ì—†ìŒ)",
          noTags: "íƒœê·¸ ì—†ìŒ",
          editBtn: "ìˆ˜ì •",
          deleteBtn: "ì‚­ì œ",
          noDate: "ë‚ ì§œ ì—†ìŒ",
          importSuccess: "ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
          importFail: "ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {error}",
          importMergeConfirm: "ê¸°ì¡´ ê¸°ë¡ì— í•©ì¹ ê¹Œìš”?\n(ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ ê¸°ë¡ì„ ë®ì–´ì”ë‹ˆë‹¤)",
          importFormatError: "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        },
        en: {
          title: "Dream Journal",
          subtitle: "Personal dream journal saved in browser (uses localStorage).<br />Backup with export (JSON) or restore with import (JSON).",
          recordTitle: "Record",
          dateLabel: "Date",
          lucidLabel: "Lucid dream",
          lucidNo: "No",
          lucidYes: "Yes",
          moodLabel: "Mood",
          tagsLabel: "Tags (comma-separated)",
          tagsPlaceholder: "e.g., school, ocean, chase",
          titleLabel: "Title",
          titlePlaceholder: "e.g., Walking on the ocean",
          contentLabel: "Content",
          contentPlaceholder: "Write your dream freely.",
          saveBtn: "Save",
          resetBtn: "Reset",
          deleteSelectedBtn: "Delete selected",
          backupTitle: "Backup/Restore",
          exportBtn: "Export (JSON)",
          importBtn: "Import (JSON)",
          storageNote: "Storage: <span class=\"mono\">localStorage</span> (this browser/device only)",
          searchLabel: "Search",
          searchPlaceholder: "Search title/content/tags",
          filterMoodLabel: "Mood filter",
          filterMoodAll: "All",
          sortLabel: "Sort",
          sortNew: "Newest",
          sortOld: "Oldest",
          emptyMessage: "No records yet. Save a dream on the left.",
          otherServices: "View other services â†—",
          alertDateRequired: "Please select a date.",
          alertContentRequired: "Please enter a title or content.",
          confirmDelete: "Delete {count} record(s)?",
          confirmDeleteOne: 'Delete "{title}"?',
          lucidDream: "Lucid",
          normalDream: "Normal",
          noTitle: "(No title)",
          noTags: "No tags",
          editBtn: "Edit",
          deleteBtn: "Delete",
          noDate: "No date",
          importSuccess: "Import completed.",
          importFail: "Import failed: {error}",
          importMergeConfirm: "Merge with existing records?\n(Cancel to overwrite existing records)",
          importFormatError: "Invalid format.",
        },
      };

      const defaultLang = "ko";
      const supportedLangs = ["ko", "en"];
      let currentLang = defaultLang;

      function t(key, vars = {}) {
        const langTable = translations[currentLang] || translations.ko;
        const template = langTable?.[key] ?? translations.ko?.[key] ?? key;
        if (typeof template !== "string") {
          return template;
        }
        return template.replace(/\{(\w+)\}/g, (_, token) =>
          vars[token] !== undefined ? vars[token] : `{${token}}`
        );
      }

      function applyTranslations() {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll("[data-i18n-html]").forEach((el) => {
          el.innerHTML = t(el.dataset.i18nHtml);
        });
        document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
          el.placeholder = t(el.dataset.i18nPlaceholder);
        });
        // Update select options
        const lucidSelect = $("lucid");
        if (lucidSelect) {
          Array.from(lucidSelect.options).forEach((opt) => {
            if (opt.value === "no") opt.textContent = t("lucidNo");
            if (opt.value === "yes") opt.textContent = t("lucidYes");
          });
        }
        const moodSelect = $("mood");
        if (moodSelect) {
          // Mood options are emoji-based, keep as is
        }
        const filterMoodSelect = $("filterMood");
        if (filterMoodSelect) {
          Array.from(filterMoodSelect.options).forEach((opt) => {
            if (opt.value === "") opt.textContent = t("filterMoodAll");
          });
        }
        const sortSelect = $("sort");
        if (sortSelect) {
          Array.from(sortSelect.options).forEach((opt) => {
            if (opt.value === "new") opt.textContent = t("sortNew");
            if (opt.value === "old") opt.textContent = t("sortOld");
          });
        }
        // Update labels
        const labels = {
          date: "dateLabel",
          lucid: "lucidLabel",
          mood: "moodLabel",
          tags: "tagsLabel",
          title: "titleLabel",
          content: "contentLabel",
          search: "searchLabel",
          filterMood: "filterMoodLabel",
          sort: "sortLabel",
        };
        Object.entries(labels).forEach(([id, key]) => {
          const label = document.querySelector(`label[for="${id}"]`);
          if (label) label.textContent = t(key);
        });
        // Update placeholders
        const placeholders = {
          tags: "tagsPlaceholder",
          title: "titlePlaceholder",
          content: "contentPlaceholder",
          search: "searchPlaceholder",
        };
        Object.entries(placeholders).forEach(([id, key]) => {
          const input = $(id);
          if (input) input.placeholder = t(key);
        });
        // Update buttons
        saveBtn.textContent = t("saveBtn");
        resetBtn.textContent = t("resetBtn");
        deleteSelectedBtn.textContent = t("deleteSelectedBtn");
        exportBtn.textContent = t("exportBtn");
        importBtn.textContent = t("importBtn");
        emptyEl.textContent = t("emptyMessage");
        // Re-render to update dynamic content
        render();
      }

      function setLang(lang, options = {}) {
        const nextLang = translations[lang] ? lang : defaultLang;
        currentLang = nextLang;
        document.documentElement.lang = nextLang;
        localStorage.setItem("preferredLang", nextLang);
        document.querySelectorAll(".lang-switch button").forEach((button) => {
          button.classList.toggle("active", button.dataset.lang === nextLang);
        });
        applyTranslations();
        if (options.updateUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set("lang", nextLang);
          window.history.replaceState({}, "", url);
        }
      }

      function detectLang() {
        const params = new URLSearchParams(window.location.search);
        const paramLang = params.get("lang");
        if (supportedLangs.includes(paramLang)) return paramLang;
        const stored = localStorage.getItem("preferredLang");
        if (supportedLangs.includes(stored)) return stored;
        const browserLang =
          navigator.languages && navigator.languages.length
            ? navigator.languages[0]
            : navigator.language;
        if (browserLang && browserLang.toLowerCase().startsWith("ko")) {
          return "ko";
        }
        return defaultLang;
      }

      document.querySelectorAll(".lang-switch button").forEach((button) => {
        button.addEventListener("click", () => {
          setLang(button.dataset.lang, { updateUrl: true });
        });
      });

      setLang(detectLang(), { updateUrl: false });
    </script>
  </body>
</html>
